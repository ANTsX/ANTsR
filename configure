#!/bin/bash
# retrieve Rcpp and R include and link directories
# R_DIR=(set by the user from command line)
RCPP_INCLUDE_DIR=`${R_DIR}Rscript -e 'Rcpp:::CxxFlags()'`
RCPP_LIB_DIR=`${R_DIR}Rscript -e 'Rcpp:::LdFlags()'`
R_INCLUDE_DIR=`${R_DIR}R CMD config --cppflags`
R_LIB_DIR=`${R_DIR}R CMD config --ldflags`
JTHREADS=2
if [[ `uname` -eq Darwin ]] ; then
  CMAKE_BUILD_TYPE=MinSizeRel
fi
if [[ $TRAVIS -eq true ]] ; then
  CMAKE_BUILD_TYPE=MinSizeRel
  JTHREADS=2
fi
cd ./src
antstag=befe3dc8f6c8089fe0fe6ee475482de0cb6d3bb4
antsgit=https://github.com/stnava/ANTs.git
itktag=a664dadfbc39d190449c6ecb9d0ffe93901a24d3
itkgit=https://github.com/InsightSoftwareConsortium/ITK.git
if [[ ! -s ants ]] ; then
  mkdir ants itks antb itkb
  git clone $itkgit itks
  cd itkb
  # -D ITKGroup_Core=On -D Module_ITKReview=On -D ITKGroup_Filtering=On -D ITKModule_MGHIO=On -D ITKGroup_IO=On -D ITKGroup_Numerics=On -D ITKGroup_Registration=On -D ITKGroup_Segmentation=On 
  cmake -D BUILD_EXAMPLES=OFF -D BUILD_TESTING=OFF -D ITK_BUILD_DEFAULT_MODULES=ON -D CMAKE_BUILD_TYPE:STRING="${CMAKE_BUILD_TYPE}" -D CMAKE_INSTALL_PREFIX:PATH=./ ../itks
  make -j $JTHREADS | grep -v "Installing" | grep -v "Looking for"
  make install | grep -v "Installing" | grep -v "Looking for"
  cd ../
  git clone $antsgit ants
  cd antb
  cmake -D ITK_DIR:PATH=../itkb/ -D BUILD_EXTERNAL_APPLICATIONS=OFF -D BUILD_ALL_ANTS_APPS=OFF -D USE_SYSTEM_ITK=OFF -D BUILD_TESTING=OFF -D CMAKE_BUILD_TYPE:STRING="${CMAKE_BUILD_TYPE}"  ../ants
  make -j $JTHREADS | grep -v "Installing" | grep -v "Looking for"
  cd ..
  cp antsr.h ants/Examples/include/
fi
