<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resting BOLD (basic analyses using ANTsR) • ANTsR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Resting BOLD (basic analyses using ANTsR)">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ANTsR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.6.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/ANTsR.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/deformationSimulation.html">Simulate a deformation field with ANTsR</a>
    </li>
    <li>
      <a href="../articles/iMath.html">iMath (mathematical operations inside ANTsR)</a>
    </li>
    <li>
      <a href="../articles/multivarTemplateCoordinates.html">multivariate template coordinates example for eigenanatomy</a>
    </li>
    <li>
      <a href="../articles/RestingBOLD.html">Resting BOLD (basic analyses using ANTsR)</a>
    </li>
    <li>
      <a href="../articles/simlr_interpretation.html">simlr_interpretation</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Resting BOLD (basic analyses using ANTsR)</h1>
                        <h4 data-toc-skip class="author">Jeffrey T.
Duda, Brian B. Avants</h4>
            
            <h4 data-toc-skip class="date">2025-07-31</h4>
      

      <div class="hidden name"><code>RestingBOLD.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This document provides some examples illustrating how <a href="https://github.com/stnava/ANTsR" class="external-link">ANTsR</a> may be used to analyze
resting state BOLD fMRI data using established methodology. The focus is
on processing the BOLD signal, here we start with the the following
data</p>
<ul>
<li><p>A BOLD fMRI time-series image</p></li>
<li><p>A brain mask image</p></li>
<li><p>A tissue-segmentation that identifies (at least): CSF, gray
matter, white matter</p></li>
<li><p>A set of labels identifying anatomical regions of interest (the
network to analyze)</p></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r.igraph.org/" class="external-link">igraph</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">pracma</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.mbalcilar.net" class="external-link">mFilter</a></span><span class="op">)</span></span>
<span><span class="va">fdthresh</span> <span class="op">=</span> <span class="fl">0.1</span> <span class="co"># threshold for throwing out bad data, typically between 0.1 and 0.5</span></span>
<span><span class="co"># based on ACT output or sample data</span></span>
<span><span class="va">id</span> <span class="op">=</span> <span class="st">"BAvants"</span></span>
<span><span class="va">pre</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"~/rsfTest/"</span>,<span class="va">id</span>,<span class="st">"/"</span>,sep<span class="op">=</span><span class="st">''</span><span class="op">)</span></span>
<span><span class="va">fn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/path.expand.html" class="external-link">path.expand</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span> <span class="va">pre</span>, <span class="st">"rsfMRI0/"</span>,<span class="va">id</span>,<span class="st">"_rsfMRI0.nii.gz"</span>, sep<span class="op">=</span><span class="st">''</span> <span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">testData</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="kw">if</span> <span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span> <span class="va">fn</span> <span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>  <span class="va">fdthresh</span> <span class="op">=</span> <span class="fl">0.2</span> <span class="co"># threshold for throwing out bad data, typically between 0.1 and 0.5</span></span>
<span>  <span class="va">testData</span> <span class="op">=</span> <span class="fl">3</span></span>
<span>  <span class="va">imgIn</span>  <span class="op">=</span> <span class="fu"><a href="../reference/antsImageRead.html">antsImageRead</a></span><span class="op">(</span> <span class="va">fn</span>  <span class="op">)</span></span>
<span>  <span class="va">meanbold</span> <span class="op">=</span> <span class="fu"><a href="../reference/getAverageOfTimeSeries.html">getAverageOfTimeSeries</a></span><span class="op">(</span> <span class="va">imgIn</span> <span class="op">)</span></span>
<span>  <span class="va">mask</span> <span class="op">=</span> <span class="fu"><a href="../reference/getMask.html">getMask</a></span><span class="op">(</span> <span class="va">meanbold</span> <span class="op">)</span></span>
<span>  <span class="va">sfn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/path.expand.html" class="external-link">path.expand</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span> <span class="va">pre</span>, <span class="st">"/act/"</span>, <span class="va">id</span>,<span class="st">"_STRUCTURAL_BrainSegmentation.nii.gz"</span>, sep<span class="op">=</span><span class="st">''</span> <span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="va">seg</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsImageRead.html">antsImageRead</a></span><span class="op">(</span> <span class="va">sfn</span>   <span class="op">)</span></span>
<span>  <span class="va">t1fn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/path.expand.html" class="external-link">path.expand</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span> <span class="va">pre</span>, <span class="st">"/act/"</span>, <span class="va">id</span>,<span class="st">"_STRUCTURAL_BrainSegmentation0N4.nii.gz"</span>, sep<span class="op">=</span><span class="st">''</span> <span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="va">t1</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsImageRead.html">antsImageRead</a></span><span class="op">(</span> <span class="va">t1fn</span>   <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="co"># use sample data</span></span>
<span>  <span class="va">imgIn</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsImageRead.html">antsImageRead</a></span><span class="op">(</span><span class="fu"><a href="../reference/getANTsRData.html">getANTsRData</a></span><span class="op">(</span><span class="st">"rsbold"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">meanbold</span> <span class="op">=</span> <span class="fu"><a href="../reference/getAverageOfTimeSeries.html">getAverageOfTimeSeries</a></span><span class="op">(</span> <span class="va">imgIn</span> <span class="op">)</span></span>
<span>  <span class="va">mask</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsImageRead.html">antsImageRead</a></span><span class="op">(</span><span class="fu"><a href="../reference/getANTsRData.html">getANTsRData</a></span><span class="op">(</span><span class="st">"rsboldmask"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">seg</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsImageRead.html">antsImageRead</a></span><span class="op">(</span><span class="fu"><a href="../reference/getANTsRData.html">getANTsRData</a></span><span class="op">(</span><span class="st">"rsboldseg"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">t1</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsImageClone.html">antsImageClone</a></span><span class="op">(</span> <span class="va">seg</span> <span class="op">)</span></span>
<span>  <span class="va">t1</span><span class="op">[</span> <span class="va">t1</span> <span class="op">&gt;</span> <span class="fl">3</span> <span class="op">]</span> <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t1brain</span> <span class="op">=</span> <span class="va">t1</span> <span class="op">*</span> <span class="fu"><a href="../reference/thresholdImage.html">thresholdImage</a></span><span class="op">(</span> <span class="va">seg</span>, <span class="fl">1</span>, <span class="fl">6</span> <span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"boldmap"</span><span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="va">boldmap</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsRegistration.html">antsRegistration</a></span><span class="op">(</span> <span class="va">meanbold</span>, <span class="va">t1brain</span>, typeofTransform<span class="op">=</span><span class="st">'SyNBoldAff'</span> <span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"mnimap"</span><span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>  <span class="va">mni</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsImageRead.html">antsImageRead</a></span><span class="op">(</span> <span class="fu"><a href="../reference/getANTsRData.html">getANTsRData</a></span><span class="op">(</span> <span class="st">"mni"</span> <span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="va">mnimap</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsRegistration.html">antsRegistration</a></span><span class="op">(</span> <span class="va">t1brain</span>, <span class="va">mni</span>, typeofTransform<span class="op">=</span><span class="st">'SyN'</span> <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">mni2boldmaps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="va">boldmap</span><span class="op">$</span><span class="va">fwdtransforms</span>, <span class="va">mnimap</span><span class="op">$</span><span class="va">fwdtransforms</span> <span class="op">)</span></span>
<span><span class="va">mni2boldmapsInv</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>  <span class="va">mnimap</span><span class="op">$</span><span class="va">invtransforms</span> , <span class="va">boldmap</span><span class="op">$</span><span class="va">invtransforms</span> <span class="op">)</span></span>
<span><span class="va">mni2bold</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsApplyTransforms.html">antsApplyTransforms</a></span><span class="op">(</span> <span class="va">meanbold</span>, <span class="va">mni</span>, <span class="va">mni2boldmaps</span> <span class="op">)</span></span>
<span><span class="va">seg2bold</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsApplyTransforms.html">antsApplyTransforms</a></span><span class="op">(</span> <span class="va">meanbold</span>, <span class="va">seg</span>, <span class="va">boldmap</span><span class="op">$</span><span class="va">fwdtransforms</span>, interpolator <span class="op">=</span> <span class="st">"NearestNeighbor"</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="va">meanbold</span> , <span class="va">boldmap</span><span class="op">$</span><span class="va">warpedmovout</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> <span class="fu"><a href="../reference/iMath.html">iMath</a></span><span class="op">(</span><span class="st">"Canny"</span>, <span class="fl">10</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="va">meanbold</span> , <span class="va">mni2bold</span> <span class="op"><a href="../reference/grapes-greater-than-grapes.html">%&gt;%</a></span> <span class="fu"><a href="../reference/iMath.html">iMath</a></span><span class="op">(</span><span class="st">"Canny"</span>, <span class="fl">10</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="va">meanbold</span> , <span class="fu"><a href="../reference/maskImage.html">maskImage</a></span><span class="op">(</span> <span class="va">seg2bold</span>, <span class="va">seg2bold</span>, <span class="fl">2</span> <span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p>Obtaining these for your own data set is a non-trivial matter, but
will be the topic of a future document as the process is the same for
both resting and task-based BOLD.</p>
<p>The processing here is largely based upon a recent review of methods
for dealing with motion in resting fMRI <span class="citation">(Power et
al. 2014)</span>.</p>
<p>The Preprocessing section includes methods used for processing fMRI
for a variety of purposes. This is followed by a section on Connectivity
processing that includes steps specific to the processing of resting
state data. Finally, a section on building graphs and calculating graph
metrics is presented.</p>
</div>
<div class="section level2">
<h2 id="preprocessing">Preprocessing<a class="anchor" aria-label="anchor" href="#preprocessing"></a>
</h2>
<p>One step that is omitted here is slice timing correction as this can
vary greatly between acquisition sequences. The included steps are:</p>
<ul>
<li><p>Removal of initial time points that occur before magnetization
steady state is reached</p></li>
<li><p>Rigid registration of time points to correct for subject head
motion</p></li>
<li><p>Plotting of motion parameters for inspection</p></li>
<li><p>Identification of “bad” time points for exclusion</p></li>
</ul>
<div class="section level3">
<h3 id="steady-state">Steady-state<a class="anchor" aria-label="anchor" href="#steady-state"></a>
</h3>
<p>The first step is the removal of pre steady state time points. It is
typical to exclude any data obtained during the first 10 seconds as
shown below. The choice of 10s is based on an informal review of current
literature of 3T human data <span class="citation">(Power et al.
2012)</span>. For other applications, be sure to check the relevant
literature.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Find first steady state timepoint</span></span>
<span><span class="va">tr</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsImageGetSet.html">antsGetSpacing</a></span><span class="op">(</span><span class="va">imgIn</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="va">steady</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fl">10.0</span> <span class="op">/</span> <span class="va">tr</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Global signal before cropping (save for visualization)</span></span>
<span><span class="va">origmean</span> <span class="op">=</span> <span class="fu"><a href="../reference/getAverageOfTimeSeries.html">getAverageOfTimeSeries</a></span><span class="op">(</span> <span class="va">imgIn</span> <span class="op">)</span></span>
<span><span class="va">fullmean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="../reference/timeseries2matrix.html">timeseries2matrix</a></span><span class="op">(</span><span class="va">imgIn</span>, <span class="va">mask</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">allTimes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">imgIn</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Eliminate non steady-state timepoints</span></span>
<span><span class="va">img</span> <span class="op">=</span> <span class="fu"><a href="../reference/cropIndices.html">cropIndices</a></span><span class="op">(</span><span class="va">imgIn</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="va">steady</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">imgIn</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p>In the plot below, mean global signal in the brain is plotted with a
red box indicating the points at which the system has non yet reached
the steady state. Data in this range are discarded.</p>
<p>The temporal mean of the original time series data:</p>
</div>
<div class="section level3">
<h3 id="motion-correction">Motion correction<a class="anchor" aria-label="anchor" href="#motion-correction"></a>
</h3>
<p>To correct for rigid body motion that occurs during acquisition:</p>
<ul>
<li><p>Find the mean volume of all time points. This is done with
<code>apply.antsImage</code> which is an extension of the <code>R</code>
method <code>apply</code> with additional functionality to maintain
image header info integrity.</p></li>
<li><p>Align all time-points to the mean. This is accomplished with
<code>antsMotionCalculation</code>, the <code>fixed</code> parameter is
used to set the reference image to which all time-points are aligned and
the <code>txtype</code> parameter indicates the type of transform to be
estimated. The default for <code>txtype</code> is “Affine”, but for this
type of analyses it is typical to use “Rigid”.</p></li>
<li><p>To help ensure an accurate fit, 3 iterations of the above steps
are used</p></li>
<li><p>Examine motion correction parameters for quality
control.</p></li>
<li><p>Identify “bad” time points for removal</p></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"moco"</span><span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>  <span class="va">meanbold</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getAverageOfTimeSeries.html">getAverageOfTimeSeries</a></span><span class="op">(</span> <span class="va">img</span> <span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span> <span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">testData</span> <span class="op">)</span></span>
<span>    <span class="op">{</span></span>
<span>    <span class="va">moco</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/antsrMotionCalculation.html">antsrMotionCalculation</a></span><span class="op">(</span> <span class="va">img</span>, fixed<span class="op">=</span><span class="va">meanbold</span>, typeofTransform<span class="op">=</span><span class="st">"Rigid"</span> <span class="op">)</span></span>
<span>    <span class="va">meanbold</span> <span class="op">=</span> <span class="fu"><a href="../reference/getAverageOfTimeSeries.html">getAverageOfTimeSeries</a></span><span class="op">(</span> <span class="va">moco</span><span class="op">$</span><span class="va">moco_img</span> <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p>It can also be informative to plot the data as a matrix, where each
row is the time-series for a voxels. Due to the large number of voxels
however, using just a sample of the voxels is much faster</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nVox</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="../reference/as.array.html">as.array</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">vox</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nVox</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/as.antsImage.html">as.antsImage</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="../reference/timeseries2matrix.html">timeseries2matrix</a></span><span class="op">(</span><span class="va">img</span>,<span class="va">mask</span><span class="op">)</span><span class="op">[</span>,<span class="va">vox</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/as.antsImage.html">as.antsImage</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="../reference/timeseries2matrix.html">timeseries2matrix</a></span><span class="op">(</span><span class="va">moco</span><span class="op">$</span><span class="va">moco_img</span>,<span class="va">mask</span><span class="op">)</span><span class="op">[</span>,<span class="va">vox</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Plotting the registration parameters from the motion correction
provides a qualitative feel for how much motion is in the data. In
addition to the registration parameters, we plot the mean framewise
displacement, which measures the average displacement of voxels, between
consecutive time points.</p>
<p>Another metric that is typically plotted is the DVARS (D for temporal
derivative, VARS for RMS variance over voxels) which illustrates the
BOLD signal change across the brain between consecutive time points.
First the BOLD signal is adjusted to have mean=1000 so that 10 units of
BOLD value change = 1% signal change. While not necessary for a
single-subject examination, this helps in inter-subject comparisons.</p>
</div>
<div class="section level3">
<h3 id="identify-bad-time-points">Identify “bad” time-points<a class="anchor" aria-label="anchor" href="#identify-bad-time-points"></a>
</h3>
<p>The motion parameters are often used to identify “bad” timepoints. A
mean framewise displacement greater than 0.2mm is a common threshold
used in human data. For illustrative purposes, we will use a threshold
of 0.1 mm. Because the displacement is a measure of motion between two
timepoints, both timepoints associated with the displacement are marked
as bad.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fdthresh</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span> <span class="va">moco</span><span class="op">$</span><span class="va">fd</span><span class="op">$</span><span class="va">MeanDisplacement</span>, <span class="fl">0.98</span> <span class="op">)</span></span>
<span><span class="va">badtimes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">moco</span><span class="op">$</span><span class="va">fd</span><span class="op">$</span><span class="va">MeanDisplacement</span> <span class="op">&gt;</span> <span class="va">fdthresh</span> <span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span> <span class="va">badtimes</span> <span class="op">)</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">)</span> <span class="va">badtimes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">badtimes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">badtimes</span>, <span class="va">badtimes</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">goodtimes</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nTimes</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="va">badtimes</span><span class="op">]</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="connectivity-processing">Connectivity processing<a class="anchor" aria-label="anchor" href="#connectivity-processing"></a>
</h2>
<p>The steps here are:</p>
<ul>
<li><p>Demean and detrend the data</p></li>
<li><p>Regress out nuisance parameters</p></li>
<li><p>Frequency filtering</p></li>
<li><p>Spatial smoothing</p></li>
</ul>
<div class="section level3">
<h3 id="detrending-the-data">Detrending the data<a class="anchor" aria-label="anchor" href="#detrending-the-data"></a>
</h3>
<p>The time-series data is detrended while excluding the bad timepoints
identified earlier. The global signal (mean signal over the whole brain)
is used to illustrate the effect of the demeaning &amp; detrending.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">global_pre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="../reference/timeseries2matrix.html">timeseries2matrix</a></span><span class="op">(</span><span class="va">img</span>, <span class="va">mask</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">global_moco</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="../reference/timeseries2matrix.html">timeseries2matrix</a></span><span class="op">(</span><span class="va">moco</span><span class="op">$</span><span class="va">moco_img</span>, <span class="va">mask</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">boldMat</span> <span class="op">=</span> <span class="fu"><a href="../reference/timeseries2matrix.html">timeseries2matrix</a></span><span class="op">(</span><span class="va">moco</span><span class="op">$</span><span class="va">moco_img</span>, <span class="va">mask</span><span class="op">)</span></span>
<span><span class="va">boldMat</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/pracma/man/detrend.html" class="external-link">detrend</a></span><span class="op">(</span><span class="va">boldMat</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">boldMat</span><span class="op">[</span><span class="va">badtimes</span>,<span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="va">global_moco_detrend</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">boldMat</span><span class="op">)</span></span>
<span><span class="va">global_pre</span><span class="op">[</span><span class="va">badtimes</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">global_moco</span><span class="op">[</span><span class="va">badtimes</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="collect-nuisance-parameters-to-regress-out">Collect nuisance parameters to regress out<a class="anchor" aria-label="anchor" href="#collect-nuisance-parameters-to-regress-out"></a>
</h3>
<p>Some typical nuisance parameters are</p>
<ul>
<li><p>detrended motion parameters, their squares, and the derivatives
of both</p></li>
<li><p>mean signal in white matter &amp; it’s derivative</p></li>
<li><p>mean signal in CSF &amp; it’s derivative</p></li>
<li><p>physiologocial noise estimated via <code>compcor</code></p></li>
<li>
<p>global mean signal in brain &amp; it’s derivative</p>
<ul>
<li>NOTE: this is a controversial topic, see below</li>
</ul>
</li>
</ul>
<p>There are two camps when it comes to global signal, some leave it in,
others regress it out. It is unclear which is best. Here we will include
it as a nuisance parameter as done in the paper on which the methods are
based. This should not be interpreted as an implied endorsement of one
camp over the other. The values at “bad” timepoints are interpolated
with splines so that derivatives may be calculated without “spreading”
the influence of the bad time points.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># white matter is labeled as 3</span></span>
<span><span class="va">wmMask</span> <span class="op">=</span> <span class="va">seg2bold</span><span class="op">*</span><span class="fl">1</span><span class="op">*</span><span class="va">mask</span></span>
<span><span class="va">wmMask</span><span class="op">[</span> <span class="va">wmMask</span> <span class="op">!=</span> <span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">wmMask</span><span class="op">[</span> <span class="va">wmMask</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">wmMask</span> <span class="op">=</span> <span class="fu"><a href="../reference/iMath.html">iMath</a></span><span class="op">(</span> <span class="va">wmMask</span>, <span class="st">"ME"</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">wmVox</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">wmMask</span>, <span class="va">mask</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">wmMean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">boldMat</span><span class="op">[</span>,<span class="va">wmVox</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CSF is labeled as 1</span></span>
<span><span class="va">csfMask</span> <span class="op">=</span> <span class="va">seg2bold</span><span class="op">*</span><span class="fl">1</span></span>
<span><span class="va">csfMask</span><span class="op">[</span> <span class="va">csfMask</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="co">#csfMask = iMath( csfMask, "ME", 1)</span></span>
<span><span class="va">csfVox</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">csfMask</span>, <span class="va">mask</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">csfMean</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">boldMat</span><span class="op">[</span>,<span class="va">csfVox</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#csfMean = rowMeans(timeseries2matrix(detrendImg, csfMask))</span></span>
<span></span>
<span><span class="va">globalMean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">boldMat</span><span class="op">)</span></span>
<span><span class="va">ncompcor</span> <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="va">compcorTemp</span> <span class="op">=</span> <span class="fu"><a href="../reference/compcor.html">compcor</a></span><span class="op">(</span><span class="va">boldMat</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="op">]</span>, ncompcor <span class="op">=</span> <span class="va">ncompcor</span><span class="op">)</span></span>
<span><span class="va">compcorNuis</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">nTimes</span>, <span class="va">ncompcor</span> <span class="op">)</span></span>
<span><span class="va">compcorNuis</span><span class="op">[</span><span class="va">goodtimes</span>, <span class="op">]</span> <span class="op">=</span> <span class="va">compcorTemp</span></span>
<span><span class="va">compcorNuis</span><span class="op">[</span><span class="va">badtimes</span>, <span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span> <span class="va">compcorNuis</span> <span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"compcor"</span>,<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">compcorNuis</span><span class="op">)</span>, sep<span class="op">=</span><span class="st">''</span> <span class="op">)</span></span>
<span><span class="va">tissueNuis</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">globalMean</span>, <span class="va">wmMean</span>, <span class="va">csfMean</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">badtimes</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">tissueNuis</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tissueInterp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/splinefun.html" class="external-link">spline</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nTimes</span><span class="op">)</span><span class="op">[</span><span class="va">goodtimes</span><span class="op">]</span>, <span class="va">tissueNuis</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="va">v</span><span class="op">]</span>,</span>
<span>      method<span class="op">=</span><span class="st">'natural'</span>, xout<span class="op">=</span><span class="va">badtimes</span> <span class="op">)</span><span class="op">$</span><span class="va">y</span></span>
<span>    <span class="va">tissueNuis</span><span class="op">[</span><span class="va">badtimes</span>,<span class="va">v</span><span class="op">]</span><span class="op">=</span><span class="va">tissueInterp</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">tissueDeriv</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">tissueNuis</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">tissueNuis</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p>The nuisance parameters are now regressed out the signal. This is
illustrated by looking at the mean signal in the cortex before and after
the regression.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mocoNuis</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">reg_params</span>, <span class="va">reg_params</span><span class="op">*</span><span class="va">reg_params</span><span class="op">)</span></span>
<span><span class="va">mocoNuis</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/pracma/man/detrend.html" class="external-link">detrend</a></span><span class="op">(</span><span class="va">mocoNuis</span><span class="op">)</span></span>
<span><span class="va">mocoDeriv</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">mocoNuis</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">mocoNuis</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">nuissance</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span> <span class="va">mocoNuis</span>, <span class="va">mocoDeriv</span>, <span class="va">tissueNuis</span>, <span class="va">tissueDeriv</span>, <span class="va">compcorNuis</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">boldMat</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span> <span class="va">boldMat</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="op">]</span> <span class="op">~</span> <span class="va">nuissance</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="op">]</span> <span class="op">)</span> <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="frequency-filtering">Frequency filtering<a class="anchor" aria-label="anchor" href="#frequency-filtering"></a>
</h3>
<p>The next step is frequency filtering. However, first we want to fill
in the “bad” timepoints with interpolated data. This is to avoid
artifacts that would result from having non-evenly sampled time-series
data. This bad timepoints will be again removed after the frequency
filtering. Frequencies with the range of 0.009 Hz - 0.08 Hz are
retained. In some cases it may be interesting to examine smaller
subranges of frequencies to look for phenomena that occur at specific
frequencies.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">badtimes</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nVox</span><span class="op">)</span> <span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">boldMat</span><span class="op">[</span><span class="va">badtimes</span>,<span class="va">v</span><span class="op">]</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/splinefun.html" class="external-link">spline</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nTimes</span><span class="op">)</span><span class="op">[</span><span class="va">goodtimes</span><span class="op">]</span>, <span class="va">boldMat</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="va">v</span><span class="op">]</span>,</span>
<span>      method<span class="op">=</span><span class="st">'natural'</span>, xout<span class="op">=</span><span class="va">badtimes</span> <span class="op">)</span><span class="op">$</span><span class="va">y</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="co"># save interpolated values for plotting</span></span>
<span><span class="va">ctxMeanSpline</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">boldMat</span><span class="op">[</span>,<span class="va">ctxVox</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fboldMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/frequencyFilterfMRI.html">frequencyFilterfMRI</a></span><span class="op">(</span> <span class="va">boldMat</span>, tr<span class="op">=</span><span class="va">tr</span>, freqLo<span class="op">=</span><span class="fl">0.009</span>, freqHi<span class="op">=</span><span class="fl">0.08</span>, opt<span class="op">=</span><span class="st">"trig"</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># save filtered values for plotting</span></span>
<span><span class="va">ctxMeanFiltered</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">fboldMat</span><span class="op">[</span>,<span class="va">ctxVox</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">ctxMeanFiltered</span><span class="op">[</span><span class="va">badtimes</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="spatial-smoothing">Spatial smoothing<a class="anchor" aria-label="anchor" href="#spatial-smoothing"></a>
</h3>
<p>Smoothing should be applied to all spatial dimensions, but the time
dimension should be left alone. It is common to smooth with a Gaussian
kernel with FWHM=6.0mm.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fimg</span> <span class="op">=</span> <span class="fu"><a href="../reference/matrix2timeseries.html">matrix2timeseries</a></span><span class="op">(</span> <span class="va">img</span>, <span class="va">mask</span>, <span class="va">fboldMat</span> <span class="op">)</span></span>
<span><span class="va">sptl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span> <span class="fu"><a href="../reference/antsImageSummary.html">sum</a></span><span class="op">(</span> <span class="fu"><a href="../reference/antsImageGetSet.html">antsGetSpacing</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simg</span> <span class="op">=</span> <span class="fu"><a href="../reference/smoothImage.html">smoothImage</a></span><span class="op">(</span> <span class="va">fimg</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">sptl</span>,<span class="fl">3</span><span class="op">)</span>,<span class="fl">0</span><span class="op">)</span>, FWHM<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="va">sboldMat</span> <span class="op">=</span> <span class="fu"><a href="../reference/timeseries2matrix.html">timeseries2matrix</a></span><span class="op">(</span><span class="va">simg</span>, <span class="va">mask</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="building-networks">Building networks<a class="anchor" aria-label="anchor" href="#building-networks"></a>
</h2>
<div class="section level3">
<h3 id="roi-definition">ROI definition<a class="anchor" aria-label="anchor" href="#roi-definition"></a>
</h3>
<p>First, a set of ROIs is needed. While each individual voxel could be
treated as an ROI, it is more common to define ROIs that contain many
voxels and represent regions for which there is some a priori knowledge
regarding the functional network to which each region belongs. The
provided network definition used here lists the center point of each ROI
so we must first create an image where each ROI is a sphere of
radius=5mm centered on the provided point.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">powers_areal_mni_itk</span><span class="op">)</span></span>
<span><span class="va">pts</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsApplyTransformsToPoints.html">antsApplyTransformsToPoints</a></span><span class="op">(</span> <span class="fl">3</span>, <span class="va">powers_areal_mni_itk</span>, transformlist <span class="op">=</span> <span class="va">mni2boldmapsInv</span> <span class="op">)</span></span>
<span><span class="va">pts</span><span class="op">[</span> , <span class="fl">4</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">pts</span><span class="op">)</span> <span class="op">]</span> <span class="op">=</span> <span class="va">powers_areal_mni_itk</span><span class="op">[</span> , <span class="fl">4</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">pts</span><span class="op">)</span> <span class="op">]</span></span>
<span><span class="va">labelImg</span> <span class="op">=</span> <span class="fu"><a href="../reference/makePointsImage.html">makePointsImage</a></span><span class="op">(</span> <span class="va">pts</span>, <span class="va">mask</span> <span class="op">)</span></span>
<span><span class="va">nPts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">pts</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="va">meanbold</span>, <span class="va">labelImg</span>, axis<span class="op">=</span><span class="fl">3</span>, nslices<span class="op">=</span><span class="fl">30</span>, ncolumns<span class="op">=</span><span class="fl">10</span>,</span>
<span>        window.overlay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">1</span>, <span class="fu"><a href="../reference/antsImageSummary.html">max</a></span><span class="op">(</span><span class="va">labelImg</span><span class="op">)</span> <span class="op">)</span> <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="getting-roi-average-signals">Getting ROI average signals<a class="anchor" aria-label="anchor" href="#getting-roi-average-signals"></a>
</h3>
<p>Now that we have roi labels, we want to find the mean time signal for
each ROI and then find the correlation matrix that give the correlation
between each of these ROI signals. We need to be careful in the case
where ROIs did not map into the image space and thus have 0 voxels.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">labelMask</span> <span class="op">=</span> <span class="va">labelImg</span><span class="op">*</span><span class="fl">1</span></span>
<span><span class="va">labelMask</span><span class="op">[</span><span class="va">labelMask</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">labelMask</span><span class="op">[</span><span class="va">mask</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">labelVox</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">labelMask</span>, <span class="va">mask</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">labeledBoldMat</span> <span class="op">=</span> <span class="va">boldMat</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="va">labelVox</span><span class="op">]</span></span>
<span><span class="va">labels</span> <span class="op">=</span> <span class="va">labelImg</span><span class="op">[</span><span class="va">labelMask</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span></span>
<span></span>
<span><span class="va">nLabels</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsImageSummary.html">max</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span></span>
<span><span class="va">roiMat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">labeledBoldMat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, ncol<span class="op">=</span><span class="va">nLabels</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span> <span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nLabels</span><span class="op">)</span> <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">labels</span><span class="op">==</span><span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span> <span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">roiMat</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">labeledBoldMat</span><span class="op">[</span>,<span class="op">(</span><span class="va">labels</span><span class="op">==</span><span class="va">i</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">nActualTimes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">roiMat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p>Plot of the ROI averaged signals</p>
<p>If system labels are provided for the ROIs, it is possible to look at
the mean and standard deviation for the BOLD signal within a system.
Comparing the mean signal between systems provides some hints about how
much those systems are working together, while the standard deviation
ribbons indicate how cohesively the components of a given system are
working.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">systemNames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pts</span><span class="op">$</span><span class="va">SystemName</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nSystems</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">systemNames</span><span class="op">)</span></span>
<span><span class="va">sysMatMean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">labeledBoldMat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, ncol<span class="op">=</span><span class="va">nSystems</span><span class="op">)</span></span>
<span><span class="va">sysMatSD</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">labeledBoldMat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, ncol<span class="op">=</span><span class="va">nSystems</span><span class="op">)</span></span>
<span></span>
<span><span class="va">systems</span> <span class="op">=</span> <span class="va">pts</span><span class="op">$</span><span class="va">SystemName</span><span class="op">[</span><span class="va">labels</span><span class="op">]</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span> <span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nSystems</span> <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sys</span> <span class="op">=</span> <span class="va">systemNames</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">sysIdx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">systems</span><span class="op">==</span><span class="va">sys</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sysIdx</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">{</span></span>
<span>    <span class="va">sysMatMean</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">labeledBoldMat</span><span class="op">[</span>,<span class="va">sysIdx</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">sysMatSD</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/apply.html">apply</a></span><span class="op">(</span><span class="va">labeledBoldMat</span><span class="op">[</span>,<span class="va">sysIdx</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">sd</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Create correlation matrix</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">missingROIs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">roiMat</span><span class="op">)</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">goodROIs</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nLabels</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">missingROIs</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">goodROIs</span> <span class="op">=</span> <span class="va">goodROIs</span><span class="op">[</span><span class="op">-</span><span class="va">missingROIs</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">connMat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">roiMat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">connMat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">connMat</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">missingROIs</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">connMat</span><span class="op">[</span><span class="va">missingROIs</span>,<span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="va">connMat</span><span class="op">[</span>,<span class="va">missingROIs</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Create mutual information matrix</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span> <span class="fu"><a href="../reference/usePkg.html">usePkg</a></span><span class="op">(</span> <span class="st">"entropy"</span> <span class="op">)</span> <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">miMat</span> <span class="op">=</span> <span class="va">connMat</span> <span class="op">*</span> <span class="fl">0</span></span>
<span>  <span class="va">nb</span> <span class="op">=</span> <span class="fl">10</span> <span class="co"># can have a strong influence on results</span></span>
<span>  <span class="va">rr1</span> <span class="op">=</span> <span class="va">rr2</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsImageSummary.html">range</a></span><span class="op">(</span> <span class="va">roiMat</span> <span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span> <span class="va">i</span> <span class="kw">in</span> <span class="va">goodROIs</span> <span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span> <span class="va">j</span> <span class="kw">in</span> <span class="va">goodROIs</span><span class="op">[</span> <span class="va">goodROIs</span> <span class="op">&gt;</span> <span class="va">i</span> <span class="op">]</span> <span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span> <span class="va">i</span> <span class="op">!=</span> <span class="va">j</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">rr1</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsImageSummary.html">range</a></span><span class="op">(</span><span class="va">roiMat</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="va">rr2</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsImageSummary.html">range</a></span><span class="op">(</span><span class="va">roiMat</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="va">y2d</span> <span class="op">=</span> <span class="fu">discretize2d</span><span class="op">(</span> <span class="va">roiMat</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>, <span class="va">roiMat</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> , <span class="va">nb</span>, <span class="va">nb</span>, r1<span class="op">=</span><span class="va">rr1</span>, r2<span class="op">=</span><span class="va">rr2</span> <span class="op">)</span></span>
<span><span class="co">#        miMat[ i, j ] =  mi.Dirichlet( y2d, a=1/8)</span></span>
<span>        <span class="va">miMat</span><span class="op">[</span> <span class="va">i</span>, <span class="va">j</span> <span class="op">]</span> <span class="op">=</span>  <span class="fu">mi.empirical</span><span class="op">(</span> <span class="va">y2d</span> <span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span> <span class="va">miMat</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">miMat</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualizing-constant-density-graphs">Visualizing constant density graphs<a class="anchor" aria-label="anchor" href="#visualizing-constant-density-graphs"></a>
</h3>
<p>Networks are often created by using a constant density. For example,
to create a network with density=0.1, we binarize the correlation matrix
to retain 10% of the edges, favoring the egdes with the highest
correlation values. The resulting adjacency matrix is then used to
create a graph.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">density</span> <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="va">nEdges</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="va">connMat</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="va">density</span></span>
<span><span class="va">thresh</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span> <span class="va">connMat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="va">connMat</span><span class="op">)</span><span class="op">]</span>, decreasing<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="va">nEdges</span><span class="op">]</span></span>
<span><span class="va">adj</span> <span class="op">=</span> <span class="fl">1</span><span class="op">*</span><span class="op">(</span><span class="va">connMat</span> <span class="op">&gt;=</span> <span class="va">thresh</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bingraph</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/graph.adjacency.html" class="external-link">graph.adjacency</a></span><span class="op">(</span><span class="va">adj</span>, mode<span class="op">=</span><span class="st">"undirected"</span>, weighted<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">components</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/clusters.html" class="external-link">clusters</a></span><span class="op">(</span><span class="va">bingraph</span><span class="op">)</span></span>
<span><span class="va">maxID</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">components</span><span class="op">$</span><span class="va">csize</span> <span class="op">==</span> <span class="fu"><a href="../reference/antsImageSummary.html">max</a></span><span class="op">(</span><span class="va">components</span><span class="op">$</span><span class="va">csize</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">adj</span><span class="op">[</span><span class="va">components</span><span class="op">$</span><span class="va">membership</span><span class="op">!=</span><span class="va">maxID</span>,<span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">adj</span><span class="op">[</span>,<span class="va">components</span><span class="op">$</span><span class="va">membership</span><span class="op">!=</span><span class="va">maxID</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">bingraph</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/graph.adjacency.html" class="external-link">graph.adjacency</a></span><span class="op">(</span><span class="va">adj</span>, mode<span class="op">=</span><span class="st">"undirected"</span>, weighted<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/as.antsImage.html">as.antsImage</a></span><span class="op">(</span><span class="va">adj</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>A more interesting way to visualize the adjacency matrix is to color
the components by the system to which they belong. Of course, this
requires that the ROIs used to define the network, include system
identifies. In the plot, connections within a system are color coded
while connections between systems are gray. For this type of plot, the
order of the rows are sorted, so that nodes in the same system are
clustered together.</p>
<p>It is also possible to export the data to a graphml file for
visualization with an application such as <a href="http://gephi.github.io/" class="external-link">GEPHI</a>. In the example, the node
colors are retained and edges for intra-system connections are colored
the same as their nodes, while inter-system edges are gray.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Retain only the largest connected component</span></span>
<span><span class="va">bingraph</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/graph.adjacency.html" class="external-link">graph.adjacency</a></span><span class="op">(</span><span class="va">adj</span>, mode<span class="op">=</span><span class="st">"undirected"</span>, weighted<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">components</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/clusters.html" class="external-link">clusters</a></span><span class="op">(</span><span class="va">bingraph</span><span class="op">)</span></span>
<span><span class="va">maxID</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">components</span><span class="op">$</span><span class="va">csize</span> <span class="op">==</span> <span class="fu"><a href="../reference/antsImageSummary.html">max</a></span><span class="op">(</span><span class="va">components</span><span class="op">$</span><span class="va">csize</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">adj</span><span class="op">[</span><span class="va">components</span><span class="op">$</span><span class="va">membership</span><span class="op">!=</span><span class="va">maxID</span>,<span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">adj</span><span class="op">[</span>,<span class="va">components</span><span class="op">$</span><span class="va">membership</span><span class="op">!=</span><span class="va">maxID</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/graph.adjacency.html" class="external-link">graph.adjacency</a></span><span class="op">(</span> <span class="va">adj</span>, mode<span class="op">=</span><span class="st">"undirected"</span>, weighted<span class="op">=</span><span class="cn">NULL</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Set node colors</span></span>
<span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/set.vertex.attribute.html" class="external-link">set.vertex.attribute</a></span><span class="op">(</span><span class="va">graph</span>, <span class="st">"r"</span>, index<span class="op">=</span><span class="fu"><a href="https://r.igraph.org/reference/V.html" class="external-link">V</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span>, value<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">pts</span><span class="op">$</span><span class="va">r</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/set.vertex.attribute.html" class="external-link">set.vertex.attribute</a></span><span class="op">(</span><span class="va">graph</span>, <span class="st">"g"</span>, index<span class="op">=</span><span class="fu"><a href="https://r.igraph.org/reference/V.html" class="external-link">V</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span>, value<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">pts</span><span class="op">$</span><span class="va">g</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/set.vertex.attribute.html" class="external-link">set.vertex.attribute</a></span><span class="op">(</span><span class="va">graph</span>, <span class="st">"b"</span>, index<span class="op">=</span><span class="fu"><a href="https://r.igraph.org/reference/V.html" class="external-link">V</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span>, value<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">pts</span><span class="op">$</span><span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set edge colors</span></span>
<span><span class="va">edges</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/ends.html" class="external-link">get.edges</a></span><span class="op">(</span> <span class="va">graph</span>, <span class="fu"><a href="https://r.igraph.org/reference/E.html" class="external-link">E</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">nEdges</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">edges</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">er</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="va">nEdges</span><span class="op">)</span></span>
<span><span class="va">eg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="va">nEdges</span><span class="op">)</span></span>
<span><span class="va">eb</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="va">nEdges</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># colors for intra-system connections</span></span>
<span><span class="co">#  gray for inter-system connections</span></span>
<span><span class="kw">for</span> <span class="op">(</span> <span class="va">e</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nEdges</span><span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span> <span class="va">pts</span><span class="op">$</span><span class="va">SystemName</span><span class="op">[</span><span class="va">edges</span><span class="op">[</span><span class="va">e</span>,<span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="va">pts</span><span class="op">$</span><span class="va">SystemName</span><span class="op">[</span><span class="va">edges</span><span class="op">[</span><span class="va">e</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span></span>
<span>   <span class="op">{</span></span>
<span>    <span class="va">er</span><span class="op">[</span><span class="va">e</span><span class="op">]</span> <span class="op">=</span> <span class="va">pts</span><span class="op">$</span><span class="va">r</span><span class="op">[</span><span class="va">edges</span><span class="op">[</span><span class="va">e</span>,<span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">eg</span><span class="op">[</span><span class="va">e</span><span class="op">]</span> <span class="op">=</span> <span class="va">pts</span><span class="op">$</span><span class="va">g</span><span class="op">[</span><span class="va">edges</span><span class="op">[</span><span class="va">e</span>,<span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">eb</span><span class="op">[</span><span class="va">e</span><span class="op">]</span> <span class="op">=</span> <span class="va">pts</span><span class="op">$</span><span class="va">b</span><span class="op">[</span><span class="va">edges</span><span class="op">[</span><span class="va">e</span>,<span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/set.edge.attribute.html" class="external-link">set.edge.attribute</a></span><span class="op">(</span><span class="va">graph</span>, <span class="st">"r"</span>, index<span class="op">=</span><span class="fu"><a href="https://r.igraph.org/reference/E.html" class="external-link">E</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span>, value<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">er</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/set.edge.attribute.html" class="external-link">set.edge.attribute</a></span><span class="op">(</span><span class="va">graph</span>, <span class="st">"g"</span>, index<span class="op">=</span><span class="fu"><a href="https://r.igraph.org/reference/E.html" class="external-link">E</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span>, value<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">eg</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/set.edge.attribute.html" class="external-link">set.edge.attribute</a></span><span class="op">(</span><span class="va">graph</span>, <span class="st">"b"</span>, index<span class="op">=</span><span class="fu"><a href="https://r.igraph.org/reference/E.html" class="external-link">E</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span>, value<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">eb</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># uncomment line below to write out graph</span></span>
<span><span class="co"># write.graph(graph, "network.graphml", format="graphml", prefixAttr=FALSE)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="graph-metrics">Graph metrics<a class="anchor" aria-label="anchor" href="#graph-metrics"></a>
</h2>
<p>Having derived a graph representation of the resting brain network,
the next logical step is to examine graph-metrics that encapsulate
various properties of the network. These are describe in further detail
in a review of graph metrics for studying connectivity in the brain
<span class="citation">(Rubinov and Sporns 2010)</span>. Two types of
metrics will be examined.</p>
<ul>
<li><p>Node measures</p></li>
<li><p>Global network measures</p></li>
</ul>
<div class="section level3">
<h3 id="node-measures">Node measures<a class="anchor" aria-label="anchor" href="#node-measures"></a>
</h3>
<p>The measures are made independently for each node/vertex in the
graph. The following is a non-comprehensive list of possible node
metrics</p>
<ul>
<li><p>Degree - the number of connections that include the node</p></li>
<li><p>Clustering coefficient - local neighborhood connectivity</p></li>
<li><p>Path length - mean shortest distance between this node and all
others</p></li>
<li><p>Local efficiency - measures “closeness” off nodes in a
neighborhood</p></li>
<li><p>Page-rank - Google page rank measure</p></li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/graph.adjacency.html" class="external-link">graph.adjacency</a></span><span class="op">(</span> <span class="va">adj</span>, mode<span class="op">=</span><span class="st">"undirected"</span>, weighted<span class="op">=</span><span class="cn">NULL</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">deg</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/degree.html" class="external-link">degree</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span></span>
<span><span class="va">deg</span><span class="op">[</span><span class="va">deg</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="va">pathsmat</span> <span class="op">=</span>  <span class="fu"><a href="https://r.igraph.org/reference/shortest.paths.html" class="external-link">shortest.paths</a></span><span class="op">(</span><span class="va">graph</span>, weights<span class="op">=</span><span class="cn">NA</span><span class="op">)</span></span>
<span><span class="va">pathsmat</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">pathsmat</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">paths</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">pathsmat</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">paths</span><span class="op">[</span><span class="va">paths</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="va">clust</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/transitivity.html" class="external-link">transitivity</a></span><span class="op">(</span><span class="va">graph</span>, type<span class="op">=</span><span class="st">"local"</span><span class="op">)</span></span>
<span><span class="va">clust</span><span class="op">[</span><span class="va">deg</span> <span class="op">&lt;</span> <span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="va">pager</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/page.rank.html" class="external-link">page.rank</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span><span class="op">$</span><span class="va">vector</span></span>
<span><span class="va">pager</span><span class="op">[</span><span class="va">deg</span> <span class="op">&lt;</span> <span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co"># from http://pastebin.com/XqkEYtJS</span></span>
<span><span class="va">leff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">deg</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">goodnodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">deg</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">leff</span><span class="op">[</span><span class="va">goodnodes</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">goodnodes</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">neighbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r.igraph.org/reference/neighbors.html" class="external-link">neighbors</a></span><span class="op">(</span><span class="va">graph</span>, v<span class="op">=</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">g.sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r.igraph.org/reference/induced.subgraph.html" class="external-link">induced.subgraph</a></span><span class="op">(</span><span class="va">graph</span>, <span class="va">neighbs</span><span class="op">)</span></span>
<span>    <span class="va">Nv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r.igraph.org/reference/gorder.html" class="external-link">vcount</a></span><span class="op">(</span><span class="va">g.sub</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">lpaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r.igraph.org/reference/shortest.paths.html" class="external-link">shortest.paths</a></span><span class="op">(</span><span class="va">g.sub</span>, weights<span class="op">=</span><span class="cn">NA</span><span class="op">)</span></span>
<span>    <span class="va">lpaths</span> <span class="op">&lt;-</span> <span class="va">paths</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="va">lpaths</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">pathsup</span> <span class="op">&lt;-</span> <span class="va">lpaths</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="va">lpaths</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="fl">2</span> <span class="op">/</span> <span class="va">Nv</span> <span class="op">/</span> <span class="op">(</span><span class="va">Nv</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="../reference/antsImageSummary.html">sum</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">lpaths</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">lpaths</span><span class="op">)</span><span class="op">==</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">leff</span><span class="op">[</span><span class="va">deg</span> <span class="op">&lt;</span> <span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">leff</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">deg</span><span class="op">)</span><span class="op">==</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="global-network-measures">Global network measures<a class="anchor" aria-label="anchor" href="#global-network-measures"></a>
</h3>
<p>The measures summarize the entire network in a single measure. All
node metrics may be meaned over all nodes to obtain a global metric.
Additional metrics include</p>
<ul>
<li><p>Global efficiency - closeness of nodes to all other
nodes</p></li>
<li><p>Clustering coefficient - same as node based, but using entire
graph as neighborhood</p></li>
</ul>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">geff</span><span class="op">&lt;-</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://r.igraph.org/reference/shortest.paths.html" class="external-link">shortest.paths</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">geff</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">geff</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="cn">NA</span></span>
<span><span class="va">geff</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">geff</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cc</span> <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/transitivity.html" class="external-link">transitivity</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span></span></code></pre></div>
<p>Finally, make a dense map of the default mode network, using
regression.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">refSignal</span> <span class="op">=</span> <span class="va">sysMatMean</span><span class="op">[</span> , <span class="va">systemNames</span> <span class="op">==</span> <span class="st">"Default Mode"</span>  <span class="op">]</span></span>
<span><span class="co"># get priors for different networks</span></span>
<span><span class="kw">if</span> <span class="op">(</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span> <span class="st">"networkPriors"</span> <span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>  <span class="va">networkPriors</span> <span class="op">=</span> <span class="fu"><a href="../reference/getANTsRData.html">getANTsRData</a></span><span class="op">(</span><span class="st">"fmrinetworks"</span><span class="op">)</span></span>
<span>  <span class="va">ilist</span> <span class="op">=</span> <span class="va">networkPriors</span><span class="op">$</span><span class="va">images</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span> <span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ilist</span><span class="op">)</span> <span class="op">)</span></span>
<span>    <span class="va">ilist</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/antsApplyTransforms.html">antsApplyTransforms</a></span><span class="op">(</span> <span class="va">meanbold</span>, <span class="va">ilist</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">mni2boldmaps</span> <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">pr</span> <span class="op">=</span> <span class="fu"><a href="../reference/imageListToMatrix.html">imageListToMatrix</a></span><span class="op">(</span> <span class="va">ilist</span>, <span class="va">mask</span> <span class="op">)</span></span>
<span><span class="va">refSignal</span> <span class="op">=</span> <span class="op">(</span> <span class="va">sboldMat</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">pr</span><span class="op">)</span> <span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">networkDf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span> ROI<span class="op">=</span><span class="va">refSignal</span><span class="op">[</span><span class="va">goodtimes</span><span class="op">]</span>,  </span>
<span>                        <span class="va">nuissance</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"compcor"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">nuissance</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>  <span class="op">)</span></span>
<span><span class="va">mdl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span> <span class="va">sboldMat</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="op">]</span> <span class="op">~</span> <span class="va">.</span> , data<span class="op">=</span><span class="va">networkDf</span> <span class="op">)</span></span>
<span><span class="va">bmdl</span> <span class="op">=</span> <span class="fu"><a href="../reference/bigLMStats.html">bigLMStats</a></span><span class="op">(</span> <span class="va">mdl</span>, <span class="fl">1.e-4</span> <span class="op">)</span></span>
<span><span class="va">betas</span> <span class="op">=</span> <span class="va">bmdl</span><span class="op">$</span><span class="va">beta.t</span><span class="op">[</span><span class="st">"ROI"</span>,<span class="op">]</span></span>
<span><span class="va">betasI</span> <span class="op">=</span> <span class="fu"><a href="../reference/makeImage.html">makeImage</a></span><span class="op">(</span> <span class="va">mask</span>, <span class="va">betas</span> <span class="op">)</span></span>
<span><span class="va">loth</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span>  <span class="va">betas</span>, probs<span class="op">=</span><span class="fl">0.5</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="va">meanbold</span>, <span class="va">betasI</span>, axis<span class="op">=</span><span class="fl">3</span>, nslices<span class="op">=</span><span class="fl">30</span>, ncolumns<span class="op">=</span><span class="fl">10</span>,</span>
<span>        window.overlay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">2</span>, <span class="fu"><a href="../reference/antsImageSummary.html">max</a></span><span class="op">(</span><span class="va">betas</span><span class="op">)</span> <span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># same thing, different denoising strategy</span></span>
<span><span class="va">dnz</span> <span class="op">=</span> <span class="fu"><a href="../reference/aslDenoiseR.html">aslDenoiseR</a></span><span class="op">(</span> <span class="va">fboldMat</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="op">]</span>, <span class="va">refSignal</span><span class="op">[</span><span class="va">goodtimes</span><span class="op">]</span>,</span>
<span>  polydegree <span class="op">=</span> <span class="fl">2</span>, crossvalidationgroups<span class="op">=</span><span class="fl">8</span>, verbose<span class="op">=</span><span class="cn">T</span> <span class="op">)</span></span>
<span><span class="va">networkDf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  ROI<span class="op">=</span><span class="va">refSignal</span><span class="op">[</span><span class="va">goodtimes</span><span class="op">]</span>,</span>
<span>  <span class="va">dnz</span><span class="op">$</span><span class="va">noiseu</span>, <span class="va">dnz</span><span class="op">$</span><span class="va">covariates</span> <span class="op">)</span></span>
<span><span class="va">mdl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span> <span class="va">sboldMat</span><span class="op">[</span><span class="va">goodtimes</span>,<span class="op">]</span> <span class="op">~</span> <span class="va">.</span> , data<span class="op">=</span><span class="va">networkDf</span> <span class="op">)</span></span>
<span><span class="va">bmdl</span> <span class="op">=</span> <span class="fu"><a href="../reference/bigLMStats.html">bigLMStats</a></span><span class="op">(</span> <span class="va">mdl</span>, <span class="fl">1.e-4</span> <span class="op">)</span></span>
<span><span class="va">betas</span> <span class="op">=</span> <span class="va">bmdl</span><span class="op">$</span><span class="va">beta.t</span><span class="op">[</span><span class="st">"ROI"</span>,<span class="op">]</span></span>
<span><span class="va">betasI</span> <span class="op">=</span> <span class="fu"><a href="../reference/makeImage.html">makeImage</a></span><span class="op">(</span> <span class="va">mask</span>, <span class="va">betas</span> <span class="op">)</span></span>
<span><span class="va">loth</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span>  <span class="va">betas</span>, probs<span class="op">=</span><span class="fl">0.5</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="va">meanbold</span>, <span class="va">betasI</span>, axis<span class="op">=</span><span class="fl">3</span>, nslices<span class="op">=</span><span class="fl">30</span>, ncolumns<span class="op">=</span><span class="fl">10</span>,</span>
<span>        window.overlay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">2</span>, <span class="fu"><a href="../reference/antsImageSummary.html">max</a></span><span class="op">(</span><span class="va">betas</span><span class="op">)</span> <span class="op">)</span> <span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Power2012" class="csl-entry">
Power, Jonathan D., Kelly A. Barnes, Abraham Z. Snyder, Bradley L.
Schlaggar, and Steven E. Petersen. 2012. <span>“Spurious but Systematic
Correlations in Functional Connectivity MRI Networks Arise from Subject
Motion.”</span> <em>Neuroimage</em> 59 (3): 2142–54. <a href="https://doi.org/10.1016/j.neuroimage.2011.10.018" class="external-link">https://doi.org/10.1016/j.neuroimage.2011.10.018</a>.
</div>
<div id="ref-Power2014" class="csl-entry">
Power, Jonathan D., Anish Mitra, Timothy O. Laumann, Abraham Z. Snyder,
Bradley L. Schlaggar, and Steven E. Petersen. 2014. <span>“Methods to
Detect, Characterize, and Remove Motion Artifact in Resting State
fMRI.”</span> <em>Neuroimage</em> 84 (January): 320–41. <a href="https://doi.org/10.1016/j.neuroimage.2013.08.048" class="external-link">https://doi.org/10.1016/j.neuroimage.2013.08.048</a>.
</div>
<div id="ref-Rubinov2010" class="csl-entry">
Rubinov, Mikail, and Olaf Sporns. 2010. <span>“Complex Network Measures
of Brain Connectivity: Uses and Interpretations.”</span>
<em>Neuroimage</em> 52 (3): 1059–69. <a href="https://doi.org/10.1016/j.neuroimage.2009.10.003" class="external-link">https://doi.org/10.1016/j.neuroimage.2009.10.003</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Brian B Avants.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
